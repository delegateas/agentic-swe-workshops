#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp","languageName":"csharp"},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"value"}]}}

#!markdown

# Playground - Agent POC med Ollama

Dette er vores POC/eksperimenterings-sandbox til at validere Ollama-integration, inden vi modificerer workshoppen.

**FormÃ¥l:**
1. Verificer at Ollama kÃ¸rer
2. Test tool calling med OllamaSharp
3. Implementer minimal agent (~200 linjer)
4. Skab `HelloAgentWorld.cs` som bevis pÃ¥ at det virker

---

## 1. Ollama Setup & Verification

#!markdown

### 1.1 Er Ollama installeret?

Ã…bn en terminal og kÃ¸r:
```powershell
winget install Ollama.Ollama
ollama serve
```

Pull modellen:
```powershell
ollama pull llama3.1:8b
```
ğŸ‘†ğŸ» Kan ogsÃ¥ udfÃ¸res i Ollama GUI

#!csharp

// Test: Kan vi nÃ¥ Ollama?
using System.Net.Http;

var httpClient = new HttpClient();

string selectedModelName = "llama3.1:8b";

try
{
    await httpClient.GetStringAsync("http://localhost:11434/api/tags");
    Console.WriteLine($"âœ… Ollama kÃ¸rer! Model: {selectedModelName}");
}
catch
{
    Console.WriteLine("âŒ Ollama kÃ¸rer IKKE. Start med: ollama serve");
}

#!markdown

### 1.2 OllamaSharp NuGet Package

#!csharp

#r "nuget: OllamaSharp, 5.1.3"

using OllamaSharp;
using OllamaSharp.Models;
using OllamaSharp.Models.Chat;

Console.WriteLine("OllamaSharp loaded!");

#!markdown

### 1.3 Simpel Chat Test (uden tools)

#!csharp

var ollama = new OllamaApiClient("http://localhost:11434");
ollama.SelectedModel = selectedModelName ?? "llama3.1:8b";

var chat = new Chat(ollama);

Console.WriteLine("Sender test besked...\n");

await foreach (var token in chat.SendAsync("Sig 'Hello agentic world!' pÃ¥ dansk."))
{
    Console.Write(token);
}

Console.WriteLine("\n\nChat virker!");

#!markdown

---

## 2. Tool Definition & Testing

#!markdown

### 2.1 Manual Tool Definition

OllamaSharp source generators virker mÃ¥ske ikke i notebooks, sÃ¥ vi bruger manuel definition:

#!csharp

using System.Text.Json;
using System.Text.Json.Nodes;

// Tool definition for create_file
var createFileTool = new OllamaSharp.Models.Chat.Tool
{
    Function = new Function
    {
        Name = "create_file",
        Description = "Create a file with the given content. Use this when the user asks you to create, write, or generate a file.",
        Parameters = new Parameters
        {
            Properties = new Dictionary<string, Property>
            {
                ["path"] = new Property
                {
                    Type = "string",
                    Description = "The file path to create (e.g., 'HelloWorld.cs')"
                },
                ["content"] = new Property
                {
                    Type = "string",
                    Description = "The content to write to the file"
                }
            },
            Required = new[] { "path", "content" }
        }
    }
};

Console.WriteLine("Tool defineret:");
Console.WriteLine($"  Name: {createFileTool.Function.Name}");
Console.WriteLine($"  Description: {createFileTool.Function.Description}");

#!markdown

### 2.2 Tool Execution Function

#!csharp

using System.IO;

string ExecuteCreateFile(string path, string content)
{
    var fullPath = Path.Combine(@"C:\code\GitHub\agentic-swe-workshops", path);

    try
    {
        File.WriteAllText(fullPath, content);
        return $"File created successfully at: {fullPath}";
    }
    catch (Exception e)
    {
        return $"Error creating file: {e.Message}";
    }
}

// Test uden LLM
var testResult = ExecuteCreateFile("test-file.txt", "Hello from test!");
Console.WriteLine(testResult);

// Cleanup
File.Delete(@"C:\code\GitHub\agentic-swe-workshops\test-file.txt");
Console.WriteLine("Test file cleaned up.");

#!markdown

---

## 3. The Agentic Loop (~200 lines demystified)

#!markdown

### 3.1 The Core Insight

Fra Mihail Eric's artikel "The Emperor Has No Clothes":

> **The LLM never actually touches your filesystem. It just *asks* for things to happen.**

Hele loopet er:
1. User sender besked
2. LLM beslutter hvad der skal ske
3. Hvis LLM vil bruge et tool â†’ vi udfÃ¸rer det lokalt
4. Resultat sendes tilbage til LLM
5. Gentag indtil LLM er fÃ¦rdig

#!csharp

// The demystified agentic loop
async Task<string> RunAgent(string userMessage, List<Tool> tools)
{
    var client = new OllamaApiClient("http://localhost:11434");
    client.SelectedModel = selectedModelName ?? "llama3.1:8b";

    var messages = new List<Message>
    {
        new Message
        {
            Role = ChatRole.System,
            Content = """
                You are a helpful coding assistant. When asked to create files,
                use the create_file tool. Always respond in the same language as
                the user's message.
                """
        },
        new Message { Role = ChatRole.User, Content = userMessage }
    };

    var maxIterations = 10;
    var iteration = 0;

    while (iteration < maxIterations)
    {
        iteration++;
        Console.WriteLine($"\n--- Iteration {iteration} ---");

        // Send to LLM
        var request = new ChatRequest
        {
            Model = selectedModelName ?? "llama3.1:8b",
            Messages = messages,
            Tools = tools,
            Stream = false
        };

        ChatResponseStream? response = null;
        await foreach (var chunk in client.ChatAsync(request))
        {
            response = chunk;
        }
        var assistantMessage = response?.Message;
        messages.Add(assistantMessage);

        // Check for tool calls
        if (assistantMessage.ToolCalls != null && assistantMessage.ToolCalls.Any())
        {
            Console.WriteLine($"LLM wants to call {assistantMessage.ToolCalls.Count()} tool(s)");

            foreach (var toolCall in assistantMessage.ToolCalls)
            {
                Console.WriteLine($"  Tool: {toolCall.Function.Name}");
                Console.WriteLine($"  Args: {JsonSerializer.Serialize(toolCall.Function.Arguments)}");

                // Execute the tool
                string toolResult;
                if (toolCall.Function.Name == "create_file")
                {
                    var args = toolCall.Function.Arguments;
                    var path = args["path"]?.ToString() ?? "unknown.txt";
                    var content = args["content"]?.ToString() ?? "";
                    toolResult = ExecuteCreateFile(path, content);
                }
                else
                {
                    toolResult = $"Unknown tool: {toolCall.Function.Name}";
                }

                Console.WriteLine($"  Result: {toolResult}");

                // Add tool result to messages
                messages.Add(new Message
                {
                    Role = ChatRole.Tool,
                    Content = toolResult
                });
            }
        }
        else
        {
            // No tool calls - LLM is done
            Console.WriteLine("LLM finished (no tool calls)");
            return assistantMessage.Content ?? "No response";
        }
    }

    return "Max iterations reached";
}

Console.WriteLine("Agentic loop function defined!");

#!markdown

### 3.2 Test: Create HelloAgentWorld.cs

#!csharp

var tools = new List<Tool> { createFileTool };

var result = await RunAgent(
    "Lav en C# fil der hedder 'HelloAgentWorld.cs' og printer 'Hello Agent World!' til konsollen.",
    tools
);

Console.WriteLine("\n=== Final Response ===");
Console.WriteLine(result);

#!markdown

### 3.3 Verify the file was created

#!csharp

var filePath = @"C:\code\GitHub\agentic-swe-workshops\HelloAgentWorld.cs";

if (File.Exists(filePath))
{
    Console.WriteLine("SUCCESS! File created:");
    Console.WriteLine(new string('-', 40));
    Console.WriteLine(File.ReadAllText(filePath));
    Console.WriteLine(new string('-', 40));
}
else
{
    Console.WriteLine("File was NOT created. Check the agent output above.");
}

#!markdown

---

## 4. MCP Servers

#!markdown

### 4.1 Hvad er MCP?

**Model Context Protocol (MCP)** er en Ã¥ben standard fra Anthropic der standardiserer
hvordan AI-agenter kommunikerer med eksterne tools.

I stedet for at definere tools inline (som i Section 2), kan tools:
- Leve i separate processer (MCP servere)
- Opdages dynamisk af agenten
- Deles pÃ¥ tvÃ¦rs af forskellige agenter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     JSON-RPC/stdio     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ MCP Server  â”‚
â”‚  (notebook) â”‚                        â”‚ (tools)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#!markdown

### 4.2 MCP Server koden

Ã…bn `McpFileServer/Program.cs` - det er samme `create_file` tool, men nu eksternaliseret:

- `[McpServerToolType]` - marker klassen som tool provider
- `[McpServerTool]` - marker metoden som et tool
- `[Description]` - beskrivelse som LLM'en kan se

#!markdown

### 4.3 MCP Client Setup

OllamaSharp har ikke indbygget MCP support, men det implementerer `IChatClient` fra
**Microsoft.Extensions.AI** - og det har MCP SDK'en fuld support for!

```
OllamaApiClient (IChatClient) â†â†’ ChatClientBuilder â†â†’ McpClientTool
                                  .UseFunctionInvocation()
```

#!csharp

// MCP Client packages
#r "nuget: ModelContextProtocol, 0.5.0-preview.1"
#r "nuget: Microsoft.Extensions.AI, 9.1.0-preview.1.25064.3"

using Microsoft.Extensions.AI;
using ModelContextProtocol.Client;

Console.WriteLine("MCP Client packages loaded!");

#!markdown

### 4.4 Opret forbindelse til MCP Server

#!csharp

// Start MCP server og hent tools
var mcpClient = await McpClient.CreateAsync(
    new StdioClientTransport(new()
    {
        Command = "dotnet",
        Arguments = ["run", "--project", "McpFileServer"],
        Name = "file-server"
    }));

var mcpTools = await mcpClient.ListToolsAsync();

Console.WriteLine($"Fundet {mcpTools.Count} tools fra MCP server:");
foreach (var tool in mcpTools)
{
    Console.WriteLine($"  - {tool.Name}: {tool.Description}");
}

#!markdown

### 4.5 Brug MCP Tools med IChatClient

OllamaApiClient implementerer `IChatClient`, sÃ¥ vi kan bruge den direkte med MCP tools!
`UseFunctionInvocation()` hÃ¥ndterer automatisk tool-kald og -resultater.

#!csharp

// OllamaApiClient IS an IChatClient - wrap it with function invocation
IChatClient chatClient = new ChatClientBuilder(ollama)
    .UseFunctionInvocation()
    .Build();

Console.WriteLine("Sender besked med MCP tools...\n");

var messages = new List<ChatMessage>
{
    new(ChatRole.User, "Lav en C# fil der hedder 'HelloMcpWorld.cs' og printer 'Hello MCP World!' til konsollen.")
};

// GetStreamingResponseAsync med MCP tools - tool calls hÃ¥ndteres automatisk!
await foreach (var update in chatClient.GetStreamingResponseAsync(
    messages,
    new() { Tools = [.. mcpTools] }))
{
    Console.Write(update.Text);
}

Console.WriteLine("\n\nDone!");

#!markdown

### 4.6 Verificer

#!csharp

var mcpFilePath = @"HelloMcpWorld.cs";

if (File.Exists(mcpFilePath))
{
    Console.WriteLine("SUCCESS! MCP tool created the file:");
    Console.WriteLine(new string('-', 40));
    Console.WriteLine(File.ReadAllText(mcpFilePath));
    Console.WriteLine(new string('-', 40));
}
else
{
    Console.WriteLine("File was NOT created. Check output above.");
}

#!markdown

---

## 5. Experimentation Zone

Brug denne sektion til at eksperimentere med:
- Forskellige prompts
- Flere MCP tools
- Egne MCP servere

#!csharp

// Din eksperimentering her...
