#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp","languageName":"csharp"},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"value"}]}}

#!markdown

# Playground - Agent POC med Ollama

Dette er vores POC/eksperimenterings-sandbox til at validere Ollama-integration, inden vi modificerer workshoppen.

**Formål:**
1. Verificer at Ollama kører
2. Test tool calling med OllamaSharp
3. Implementer minimal agent (~200 linjer)
4. Skab `HelloAgentWorld.cs` som bevis på at det virker

---

## 1. Ollama Setup & Verification

#!markdown

### 1.1 Er Ollama installeret?

Åbn en terminal og kør:
```powershell
winget install Ollama.Ollama
ollama pull llama3.1:8b
ollama list
```

#!csharp

// Test: Kan vi nå Ollama?
using System.Net.Http;
using System.Text.Json;

var httpClient = new HttpClient();
string selectedModelName = null;

try
{
    var response = await httpClient.GetStringAsync("http://localhost:11434/api/tags");
    Console.WriteLine("Ollama kører! Installerede modeller:");
    Console.WriteLine(response);

    // Parse and get first model
    var json = JsonDocument.Parse(response);
    var models = json.RootElement.GetProperty("models");
    if (models.GetArrayLength() > 0)
    {
        selectedModelName = models[0].GetProperty("name").GetString();
        Console.WriteLine($"\nValgt model: {selectedModelName}");
    }
}
catch (Exception ex)
{
    Console.WriteLine($"Ollama kører IKKE: {ex.Message}");
    Console.WriteLine("Start Ollama med: ollama serve");
}

#!markdown

### 1.2 OllamaSharp NuGet Package

#!csharp

#r "nuget: OllamaSharp, 5.1.3"

using OllamaSharp;
using OllamaSharp.Models;
using OllamaSharp.Models.Chat;

Console.WriteLine("OllamaSharp loaded!");

#!markdown

### 1.3 Simpel Chat Test (uden tools)

#!csharp

var ollama = new OllamaApiClient("http://localhost:11434");
ollama.SelectedModel = selectedModelName ?? "llama3.1:8b";

var chat = new Chat(ollama);

Console.WriteLine("Sender test besked...\n");

await foreach (var token in chat.SendAsync("Sig 'Hello agentic world!' på dansk."))
{
    Console.Write(token);
}

Console.WriteLine("\n\nChat virker!");

#!markdown

---

## 2. Tool Definition & Testing

#!markdown

### 2.1 Manual Tool Definition

OllamaSharp source generators virker måske ikke i notebooks, så vi bruger manuel definition:

#!csharp

using System.Text.Json;
using System.Text.Json.Nodes;

// Tool definition for create_file
var createFileTool = new OllamaSharp.Models.Chat.Tool
{
    Function = new Function
    {
        Name = "create_file",
        Description = "Create a file with the given content. Use this when the user asks you to create, write, or generate a file.",
        Parameters = new Parameters
        {
            Properties = new Dictionary<string, Property>
            {
                ["path"] = new Property
                {
                    Type = "string",
                    Description = "The file path to create (e.g., 'HelloWorld.cs')"
                },
                ["content"] = new Property
                {
                    Type = "string",
                    Description = "The content to write to the file"
                }
            },
            Required = new[] { "path", "content" }
        }
    }
};

Console.WriteLine("Tool defineret:");
Console.WriteLine($"  Name: {createFileTool.Function.Name}");
Console.WriteLine($"  Description: {createFileTool.Function.Description}");

#!markdown

### 2.2 Tool Execution Function

#!csharp

using System.IO;

string ExecuteCreateFile(string path, string content)
{
    var fullPath = Path.Combine(@"C:\code\GitHub\agentic-swe-workshops", path);

    try
    {
        File.WriteAllText(fullPath, content);
        return $"File created successfully at: {fullPath}";
    }
    catch (Exception e)
    {
        return $"Error creating file: {e.Message}";
    }
}

// Test uden LLM
var testResult = ExecuteCreateFile("test-file.txt", "Hello from test!");
Console.WriteLine(testResult);

// Cleanup
File.Delete(@"C:\code\GitHub\agentic-swe-workshops\test-file.txt");
Console.WriteLine("Test file cleaned up.");

#!markdown

---

## 3. The Agentic Loop (~200 lines demystified)

#!markdown

### 3.1 The Core Insight

Fra Mihail Eric's artikel "The Emperor Has No Clothes":

> **The LLM never actually touches your filesystem. It just *asks* for things to happen.**

Hele loopet er:
1. User sender besked
2. LLM beslutter hvad der skal ske
3. Hvis LLM vil bruge et tool → vi udfører det lokalt
4. Resultat sendes tilbage til LLM
5. Gentag indtil LLM er færdig

#!csharp

// The demystified agentic loop
async Task<string> RunAgent(string userMessage, List<Tool> tools)
{
    var client = new OllamaApiClient("http://localhost:11434");
    client.SelectedModel = selectedModelName ?? "llama3.1:8b";

    var messages = new List<Message>
    {
        new Message
        {
            Role = ChatRole.System,
            Content = """
                You are a helpful coding assistant. When asked to create files,
                use the create_file tool. Always respond in the same language as
                the user's message.
                """
        },
        new Message { Role = ChatRole.User, Content = userMessage }
    };

    var maxIterations = 10;
    var iteration = 0;

    while (iteration < maxIterations)
    {
        iteration++;
        Console.WriteLine($"\n--- Iteration {iteration} ---");

        // Send to LLM
        var request = new ChatRequest
        {
            Model = selectedModelName ?? "llama3.1:8b",
            Messages = messages,
            Tools = tools,
            Stream = false
        };

        var response = await client.ChatAsync(request);
        var assistantMessage = response.Message;
        messages.Add(assistantMessage);

        // Check for tool calls
        if (assistantMessage.ToolCalls != null && assistantMessage.ToolCalls.Any())
        {
            Console.WriteLine($"LLM wants to call {assistantMessage.ToolCalls.Count()} tool(s)");

            foreach (var toolCall in assistantMessage.ToolCalls)
            {
                Console.WriteLine($"  Tool: {toolCall.Function.Name}");
                Console.WriteLine($"  Args: {JsonSerializer.Serialize(toolCall.Function.Arguments)}");

                // Execute the tool
                string toolResult;
                if (toolCall.Function.Name == "create_file")
                {
                    var args = toolCall.Function.Arguments;
                    var path = args["path"]?.ToString() ?? "unknown.txt";
                    var content = args["content"]?.ToString() ?? "";
                    toolResult = ExecuteCreateFile(path, content);
                }
                else
                {
                    toolResult = $"Unknown tool: {toolCall.Function.Name}";
                }

                Console.WriteLine($"  Result: {toolResult}");

                // Add tool result to messages
                messages.Add(new Message
                {
                    Role = ChatRole.Tool,
                    Content = toolResult
                });
            }
        }
        else
        {
            // No tool calls - LLM is done
            Console.WriteLine("LLM finished (no tool calls)");
            return assistantMessage.Content ?? "No response";
        }
    }

    return "Max iterations reached";
}

Console.WriteLine("Agentic loop function defined!");

#!markdown

### 3.2 Test: Create HelloAgentWorld.cs

#!csharp

var tools = new List<Tool> { createFileTool };

var result = await RunAgent(
    "Lav en C# fil der hedder 'HelloAgentWorld.cs' og printer 'Hello Agent World!' til konsollen.",
    tools
);

Console.WriteLine("\n=== Final Response ===");
Console.WriteLine(result);

#!markdown

### 3.3 Verify the file was created

#!csharp

var filePath = @"C:\code\GitHub\agentic-swe-workshops\HelloAgentWorld.cs";

if (File.Exists(filePath))
{
    Console.WriteLine("SUCCESS! File created:");
    Console.WriteLine(new string('-', 40));
    Console.WriteLine(File.ReadAllText(filePath));
    Console.WriteLine(new string('-', 40));
}
else
{
    Console.WriteLine("File was NOT created. Check the agent output above.");
}

#!markdown

---

## 4. Experimentation Zone

Brug denne sektion til at eksperimentere med:
- Forskellige prompts
- Flere tools
- Fejlhåndtering
- Edge cases

#!csharp

// Din eksperimentering her...
